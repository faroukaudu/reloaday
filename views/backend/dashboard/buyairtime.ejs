<%- include("../../includes/dash/head", {userInfo:userInfo}); -%>

<style>
  .monnify {
    width: 15%;
    display: block;
    margin-top: 40px;
    margin-left: auto;
    margin-right: auto;
  }
  .balance { display: none; }
  .wallet { display: none; }
</style>

<script>
  var url = window.location.href;
  var arr = url.split("/");
  const netw = arr[4];

  if(netw === "AIRTEL"){ bgColor = '#F0232C'; textColor = 'white'; }
  else if (netw === "MTN"){ bgColor = '#FFC403'; textColor = 'black'; }
  else if (netw === "9Mobile"){ bgColor = '#015E43'; textColor = 'white'; }
  else if (netw === "GLO"){ bgColor = '#27883B'; textColor = 'white'; }

  const style = document.createElement('style');
  style.type = 'text/css';
  style.innerHTML = `
    input[type="text"]:disabled {
      background-color: ${bgColor};
      color: ${textColor};
      font-weight: 700;
      font-size: larger;
    }
  `;
  document.head.appendChild(style);
</script>

<div class="pcoded-content">
  <div class="pcoded-inner-content">
    <div class="main-body">
      <div class="page-wrapper">

        <div class="page-header">
          <div class="row align-items-end">
            <div class="col-lg-8">
              <div class="page-header-title">
                <div class="d-inline">
                  <h4>Buy Airtime</h4>
                  <span>Select the network you wish to purchase airtime for</span>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="page-header-breadcrumb">
                <ul class="breadcrumb-title">
                  <li class="breadcrumb-item"><a href="index-1.htm"></a></li>
                  <a href="/data" class="btn btn-primary"><i class="feather icon-home"></i>Buy Data</a>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div class="page-body">
          <div class="row">
            <div class="col-sm-12">

              <div class="card">
                <div class="card-header">
                  <div class="card-header-right">
                    <i class="icofont icofont-spinner-alt-5"></i>
                  </div>
                </div>

                <div class="row">
                  <div class="col-sm-12 col-lg-8">
                    <div class="card-block">
                      <h4 class="sub-title">Load Data Infomations</h4>

                      <!-- ✅ MAIN FORM (Wallet submits this to /airtime) -->
                      <form id="swaForm" method="post" action="/airtime">

                        <!-- ✅ Wallet balance for JS -->
                        <input type="hidden" id="walletBalance" value="<%= userInfo.wallet_balace %>">
                        <!-- ✅ optional: track medium -->
                        <input type="hidden" name="payMedium" id="payMedium" value="">

                        <div class="form-group row">
                          <label class="col-sm-2 col-form-label">Select Box</label>
                          <div class="col-sm-10">
                            <select id="networkSel" name="network" class="form-control form-bg-primary" required>
                              <option disabled selected value="">Select Network</option>
                              <option value="1">MTN</option>
                              <option value="3">AIRTEL</option>
                              <option value="2">GLO</option>
                              <option value="6">9 MOBILE</option>
                            </select>
                          </div>
                        </div>

                        <input type="hidden" value="Airtime Purchase" name="paymentDesc">

                        <div class="form-group row">
                          <label class="col-sm-2 col-form-label">Phone Number</label>
                          <div class="col-sm-10">
                            <div class="input-group">
                              <span class="input-group-addon"><i class="icofont icofont-phone"></i></span>
                              <input type="text" class="form-control form-control-round" name="phone" value="<%= userInfo.phone%>" required>
                            </div>
                          </div>
                        </div>

                        <!-- ✅ Amount input (this is what we compare to wallet) -->
                        <div class="form-group row">
                          <label class="col-sm-2 col-form-label">Amount</label>
                          <div class="col-sm-10">
                            <div class="input-group">
                              <span class="input-group-addon">₦</span>
                              <input id="airtimeAmount" type="text" class="form-control form-control-round" name="amount" value="" placeholder="0.0" required>
                            </div>
                          </div>
                        </div>

                        <div class="form-group row">
                          <label class="col-sm-2 col-form-label">Payment Medium</label>
                          <div class="col-sm-10">
                            <select id="paymed" name="select" class="form-control form-control-round">
                              <option value="" disabled selected class="description">Topup Medium</option>
                              <option value="wallet">Main Wallet</option>
                              <option value="monnify">Credit Card</option>
                              <option value="transfer">Bank Transfer</option>
                            </select>

                            <% if(userInfo.wallet_balace < 50){ %>
                              <div class="balance" style="background-color: rgba(187, 13, 13, 0.496); color: white; text-align: left; width: 30%; border-radius: 12px;">
                                <p style="margin-left: 20px; font-weight: 600; font-size: 15px;">
                                  ₦<%= userInfo.wallet_balace.toLocaleString()%>
                                  <em style="font-size: xx-small;">low Balance</em>
                                </p>
                              </div>
                            <% }else{ %>
                              <div class="balance" style="background-color: rgba(27, 191, 27, 0.496); color: white; text-align: left; width: 30%; border-radius: 12px;">
                                <p style="margin-left: 20px; font-weight: 600; font-size: 15px;">₦ <%= userInfo.wallet_balace.toLocaleString()%></p>
                              </div>
                            <% } %>

                          </div>
                        </div>

                        <!-- ✅ PAYMENT BUTTONS -->
                        <div class="form-group row">
                          <div class="col-sm-12 wallet">

                            <!-- ✅ WALLET BUTTON (checks entered amount vs wallet balance) -->
                            <button
                              type="button"
                              id="walletBtn"
                              class="btn btn-primary btn-outline-primary btn-block alert-prompt m-b-10 paymentbtn"
                              onclick="walletAirtimeGuard('<%= userInfo.trans_pin %>');"
                            >
                              <i class="icofont icofont-user-alt-3"></i>Pay with Wallet
                            </button>

                            <!-- ✅ CREDIT CARD BUTTON (only shows when monnify selected) -->
                            <button
                              type="button"
                              id="cardBtn"
                              class="btn btn-primary btn-outline-primary btn-block m-b-10"
                              style="display:none;"
                            >
                              <i class="icofont icofont-credit-card"></i>Pay with Card
                            </button>

                            <!-- ✅ BANK TRANSFER BUTTON (optional) -->
                            <button
                              type="button"
                              id="transferBtn"
                              class="btn btn-primary btn-outline-primary btn-block m-b-10"
                              style="display:none;"
                            >
                              <i class="icofont icofont-bank"></i>Pay via Bank Transfer
                            </button>

                            <img class="monnify" src="../dash-assets/assets/images/monnify.png" alt="monnify">
                          </div>
                        </div>

                      </form>

                    </div>
                  </div>

                  <div><p>Advert goes here !!!</p></div>
                </div>

              </div>

            </div>
          </div>
        </div>

      </div>
    </div>
    <div id="styleSelector"></div>
  </div>
</div>

<!-- ✅ SweetAlert + guards + dynamic buttons -->
<script>
  // =========================
  // ✅ SET YOUR ROUTES HERE
  // =========================
  // Card: POST to a route that initializes payment (recommended)
  const CARD_POST_ROUTE = "/monnify-pay";       // <-- change if needed
  // Transfer: link page (optional)
  const TRANSFER_GET_LINK = "/bank-transfer";  // <-- change if needed

  function dangerOpenLink(title, message, url) {
    swal({
      title: title || "Notice",
      text: message || "",
      type: "error",
      confirmButtonText: "OK",
      closeOnConfirm: true
    }, function () {
      window.location.href = url;
    });
  }

  function getWalletBalance() {
    return Number(document.getElementById("walletBalance").value || 0);
  }

  // ✅ Parse amount field safely (handles commas, ₦, spaces)
  function getAirtimeAmount() {
    const raw = String(document.getElementById("airtimeAmount").value || "");
    const cleaned = raw.replace(/[₦,\s]/g, ""); // remove ₦ commas spaces
    const amt = Number(cleaned);
    return Number.isFinite(amt) ? amt : 0;
  }

  // ✅ Wallet airtime guard: wallet must be >= amount
  function walletAirtimeGuard(pin) {
    const wallet = getWalletBalance();
    const amt = getAirtimeAmount();

    if (!amt || amt <= 0) {
      swal({
        title: "Invalid Amount",
        text: "Please enter a valid airtime amount.",
        type: "error",
        confirmButtonText: "OK"
      });
      return false;
    }

    if (amt > wallet) {
      swal({
        title: "Insufficient Balance",
        text: `Airtime amount ₦${amt} is more than your wallet balance ₦${wallet}. Click OK to fund wallet.`,
        type: "error",
        confirmButtonText: "Fund Wallet",
        closeOnConfirm: true
      }, function () {
        window.location.href = "/fund-wallet";
      });
      return false;
    }

    mypull(pin);
  }

  // ✅ POST to card init route (copies current form fields)
  function postToCardRoute() {
    const form = document.getElementById("swaForm");
    if (!form) return;

    const amt = getAirtimeAmount();
    if (!amt || amt <= 0) {
      swal({
        title: "Invalid Amount",
        text: "Please enter a valid airtime amount before paying with card.",
        type: "error",
        confirmButtonText: "OK"
      });
      return;
    }

    // Build new POST form
    const postForm = document.createElement("form");
    postForm.method = "POST";
    postForm.action = CARD_POST_ROUTE;

    // copy all fields
    const fields = form.querySelectorAll("input, select, textarea");
    fields.forEach((el) => {
      if (!el.name) return;

      const hidden = document.createElement("input");
      hidden.type = "hidden";
      hidden.name = el.name;
      hidden.value = el.value;
      postForm.appendChild(hidden);
    });

    // explicit medium
    const medium = document.createElement("input");
    medium.type = "hidden";
    medium.name = "payMedium";
    medium.value = "card";
    postForm.appendChild(medium);

    document.body.appendChild(postForm);
    postForm.submit();
  }

  document.addEventListener("DOMContentLoaded", function () {
    const paymed = document.getElementById("paymed");
    const walletBtn = document.getElementById("walletBtn");
    const cardBtn = document.getElementById("cardBtn");
    const transferBtn = document.getElementById("transferBtn");

    // Card button = POST
    if (cardBtn) cardBtn.onclick = function () { postToCardRoute(); };

    // Transfer button = link
    if (transferBtn) transferBtn.onclick = function () { window.location.href = TRANSFER_GET_LINK; };

    // Handle payment medium switch (same behavior as your data page)
    if (paymed) {
      paymed.addEventListener("change", function () {
        const selectedValue = this.value;

        // Reset buttons
        if (walletBtn) walletBtn.style.display = "none";
        if (cardBtn) cardBtn.style.display = "none";
        if (transferBtn) transferBtn.style.display = "none";

        if (selectedValue === "wallet") {
          document.getElementById("payMedium").value = "wallet";
          $('.monnify').hide();
          $('.balance').show();
          $('.wallet').show();
          if (walletBtn) walletBtn.style.display = "block";
          $('.paymentbtn').text('Pay with Wallet');

        } else if (selectedValue === "monnify") {
          document.getElementById("payMedium").value = "card";
          $('.balance').hide();
          $('.wallet').show();
          $('.monnify').show();
          if (cardBtn) cardBtn.style.display = "block";

        } else if (selectedValue === "transfer") {
          document.getElementById("payMedium").value = "transfer";
          $('.monnify').hide();
          $('.balance').hide();
          $('.wallet').show();
          if (transferBtn) transferBtn.style.display = "block";
        }
      });
    }
  });
</script>

<!-- Scripts -->
<script type="text/javascript" src="..\dash-assets\bower_components\jquery\js\jquery.min.js"></script>
<script type="text/javascript" src="..\dash-assets\bower_components\jquery-ui\js\jquery-ui.min.js"></script>
<script type="text/javascript" src="..\dash-assets\bower_components\popper.js\js\popper.min.js"></script>
<script type="text/javascript" src="..\dash-assets\bower_components\bootstrap\js\bootstrap.min.js"></script>
<script type="text/javascript" src="..\dash-assets\bower_components\jquery-slimscroll\js\jquery.slimscroll.js"></script>
<script type="text/javascript" src="..\dash-assets\bower_components\modernizr\js\modernizr.js"></script>
<script type="text/javascript" src="..\dash-assets\bower_components\modernizr\js\css-scrollbars.js"></script>
<script type="text/javascript" src="..\dash-assets\bower_components\sweetalert\js\sweetalert.min.js"></script>
<script type="text/javascript" src="..\dash-assets\assets\js\modal.js"></script>
<script type="text/javascript" src="..\dash-assets\assets\js\modalEffects.js"></script>
<script type="text/javascript" src="..\dash-assets\assets\js\classie.js"></script>
<script type="text/javascript" src="..\dash-assets\bower_components\i18next\js\i18next.min.js"></script>
<script type="text/javascript" src="..\dash-assets\bower_components\i18next-xhr-backend\js\i18nextXHRBackend.min.js"></script>
<script type="text/javascript" src="..\dash-assets\bower_components\i18next-browser-languagedetector\js\i18nextBrowserLanguageDetector.min.js"></script>
<script type="text/javascript" src="..\dash-assets\bower_components\jquery-i18next\js\jquery-i18next.min.js"></script>
<script src="..\dash-assets\assets\js\pcoded.min.js"></script>
<script src="..\dash-assets\assets\js\vartical-layout.min.js"></script>
<script src="..\dash-assets\assets\js\jquery.mCustomScrollbar.concat.min.js"></script>
<script type="text/javascript" src="..\dash-assets\assets\js\script.js"></script>

<script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-23581568-13"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-23581568-13');
</script>

</body>
</html>
